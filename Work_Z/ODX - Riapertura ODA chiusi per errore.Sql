-- AGGIORNO ODL_MAST

SELECT OLCODODL, OLDATODP, UTDV, MVSERIAL, CASE WHEN MVSERIAL IS NULL THEN 'P' ELSE 'L' END AS NEW_STATO, * 
--UPDATE GECAMODL_MAST SET OLTSTATO = CASE WHEN MVSERIAL IS NULL THEN 'P' ELSE 'L' END, OLTFLEVA = ''
FROM GECAMODL_MAST
LEFT OUTER JOIN GECAMDOC_DETT ON
MVCODODL=OLCODODL
WHERE OLTPROVE = 'E' 
AND CAST(UTDV AS DATE) > '2020-04-26'

/*
--AGGIORNO ODL_DETT MA PER ODA NON SERVE

SELECT * 
--UPDATE GECAMODL_DETT SET OLFLEVAS = 'N', OLQTASAL=OLQTAUM1-OLQTAEV1
FROM GECAMODL_MAST
INNER JOIN GECAMODL_DETT ON
GECAMODL_DETT.OLCODODL=GECAMODL_MAST.OLCODODL
--LEFT OUTER JOIN GECAMDOC_DETT ON
--MVCODODL=OLCODODL
WHERE GECAMODL_MAST.OLTPROVE = 'E' 
AND CAST(GECAMODL_MAST.UTDV AS DATE) > '2020-04-26'
*/

--AGGIORNO DOC_DETT
SELECT * 
--UPDATE GECAMDOC_DETT SET MVFLEVAS='', MVQTASAL=MVQTAUM1-MVQTAEV1, MVEFFEVA=NULL
FROM GECAMDOC_DETT 
INNER JOIN GECAMODL_MAST ON
MVCODODL=OLCODODL AND
CAST(GECAMODL_MAST.UTDV AS DATE) > '2020-04-26' AND
GECAMODL_MAST.OLTPROVE = 'E' 
WHERE GECAMDOC_DETT.MVQTAEV1 < GECAMDOC_DETT.MVQTAUM1 AND MVFLEVAS = 'S'


--RICORDARSI DI LANCIARE LA RICOSTRUZIONE SALDI