--ALTER VIEW [dbo].[NICIM_FIGLI_PADRI] AS

SELECT PD96_COMPON AS CODICE_FIGLIO
,PD95_CODART_MG66 AS CODICE_PADRE
,PD96_QUANT_1 AS QTA
,PD48_UP.PD48_CODFASE_PD12 AS COD_FASE
,PD48_UP.PD48_DESCRFASE AS DESC_FASE
,CASE WHEN PD48_UP.[PD48_INDTIPOPROV] = 0 THEN 'I' ELSE 'E' END AS INTEST 

FROM PD95_DISBA WITH (NOLOCK) 
INNER JOIN PD96_LEGAMIDISBA WITH (NOLOCK) ON
PD95_IDDISBA = PD96_IDDISBA_PD95 
inner join MG66_ANAGRART with(nolock) on  
PD95_DITTA_CG18=MG66_DITTA_CG18 and 
PD95_CODART_MG66=MG66_CODART
inner join PD18_ARTPROD WITH (NOLOCK) on
PD18_DITTA_CG18 = PD95_DITTA_CG18 
and PD18_CODART_MG66 = PD95_CODART_MG66 
OUTER APPLY (
	SELECT PD48_CICLO_PD52, PD48_SEQFASE, PD48_CODFASE_PD12, PD48_DESCRFASE, PD48_INDTIPOPROV
	, ROW_NUMBER() OVER (PARTITION BY PD48_CICLO_PD52 ORDER BY PD48_CICLO_PD52, PD48_SEQFASE) AS RN 
	FROM PD48_CICLI 
	WHERE PD48_DITTA_CG18 = PD18_DITTA_CG18 
		AND PD48_CICLO_PD52 = PD18_CODCICLO 
		AND PD48_VERSIONE_PD52 = 0
		AND PD48_IDDISBA_PD95 IS NULL
		AND PD48_PROGFASE = 0
		AND PD48_CODFASE_PD12 <> 9000
		) PD48_UP

WHERE PD96_COMPON LIKE '#%'
AND PD95_TIPO_DISTINTA = 0 AND MG66_INDSTATO_MG6W=50
AND PD48_UP.RN = 1