ALTER VIEW VOLPI_RIPARAZIONI AS (

SELECT DO11_DOCUM_MG36 AS COD_DOC, DO11_SEZDOC  AS SEZ_DOC, DO11_DATADOC AS DATA_DOC, DO11_NUMDOC AS NUM_DOC, DO11_CLIFOR_CG44 AS COD_CLI, CG16_RAGSOANAG AS RAGSOC_CLI
, DO17_NUMPERS1 AS TEMPO_RIP, DO17_ALFPERS2 AS COD_CAU_RIP, DO05_DESCRIZIONE AS DESCR_CAU_RIP
, DO30_ARTRIP.DO30_CODART_MG66 AS COD_ARTRIP, DO30_ARTRIP.DO30_DESCART AS DES_ARTRIP, DO30_ARTRIP.DO30_QTA1 AS QTA_ARTRIP, DO30_ARTRIP.DO30_PREZZO1 AS PRZ_ARTRIP, DO30_ARTRIP.DO30_SCPER1 AS SC1_ARTRIP, DO30_ARTRIP.DO30_SCPER2 AS SC2_ARTRIP
, DO30_ARTRIP.MG74_CODGRUSTAT1 AS COD_GRU1_ARTRIP, DO30_ARTRIP.MG74_DESGRUSTAT1 AS DES_GRU1_ARTRIP
, DO30_ARTRIP.MG53_CODFAM AS COD_FAM_ARTRIP, DO30_ARTRIP.MG53_DESCRFAM AS DES_FAM_ARTRIP
, DO30_ARTRIP.MG54_CODSFAM AS COD_SFAM_ARTRIP, DO30_ARTRIP.MG54_DESCRSFAM AS DES_SFAM_ARTRIP
, DO30_ARTRIP.MG55_CODGRUPPO AS COD_GRU_ARTRIP, DO30_ARTRIP.MG55_DESCRGRUPPO AS DES_GRU_ARTRIP
, DO30_ARTRIP.MG56_CODSGRUPPO AS COD_SGRU_ARTRIP, DO30_ARTRIP.MG56_DESCRSGRUPPO AS DES_SGRU_ARTRIP
, DO30_TEMPI.DO30_DESCART AS DES_TEMPORIP, DO30_TEMPI.DO30_QTA1 AS QTA_TEMPORIP, DO30_TEMPI.DO30_PREZZO1 AS PRZ_TEMPORIP, DO30_TEMPI.DO30_SCPER1 AS SC1_TEMPORIP, DO30_TEMPI.DO30_SCPER2 AS SC2_TEMPORIP
, DO30_PROBLEMA.DO30_DESCART AS DES_PROBLEMA, DO30_OPERAZIONE.DO30_DESCART AS DESC_OPERAZIONE
, (SELECT LTRIM(RTRIM(DO30.DO30_CODART_MG66)) + ', ' AS 'data()' 
	FROM (SELECT DO30_CODART_MG66, ROW_NUMBER() OVER (PARTITION BY DO30_DITTA_CG18, DO30_NUMREG_CO99 ORDER BY DO30_PROGVISUASTA) AS NUM_RIGA
			FROM DO30_DOCCORPO 
			WHERE DO30_DITTA_CG18=DO11_DITTA_CG18 AND DO30_NUMREG_CO99=DO11_NUMREG_CO99 AND DO30_INDTIPORIGA=0) DO30
	WHERE DO30.NUM_RIGA > 1
	FOR XML PATH('')) AS COD_COMPONENTI_UTILIZZATI
, DO35_ALFPERS4 AS MATRICOLA_1, DO35_ALFPERS3 AS MATRICOLA_2
, DO30_COSTI1.COSTOTOT, DO30_COSTI1.COSTOTO_VAL
--, '---------------------', *
FROM DO11_DOCTESTATA
LEFT OUTER JOIN DO17_DOCTESTAPERS ON
DO17_DITTA_CG18=DO11_DITTA_CG18 AND
DO17_NUMREG_CO99=DO11_NUMREG_CO99
LEFT OUTER JOIN DO05_ANAGCAMPIPERS ON
DO05_CODICE=DO17_ALFPERS2 AND
DO05_IDDEFCAMPOPERS_DO04=11
INNER JOIN CG44_CLIFOR ON
CG44_DITTA_CG18=DO11_DITTA_CG18 AND
CG44_TIPOCF=DO11_TIPOCF_CG44 AND
CG44_CLIFOR=DO11_CLIFOR_CG44
INNER JOIN CG16_ANAGGEN ON
CG16_CODICE=CG44_CODICE_CG16
OUTER APPLY (
			SELECT TOP 1 *
			FROM DO30_DOCCORPO
			INNER JOIN MG66_ANAGRART ON
			MG66_DITTA_CG18=DO30_DITTA_CG18 AND
			MG66_CODART=DO30_CODART_MG66
			LEFT OUTER JOIN MG74_GRUSTAT1 ON
			MG74_DITTA_CG18=MG66_DITTA_CG18 AND
			MG74_CODGRUSTAT1=MG66_GRUSTAT1_MG74
			LEFT OUTER JOIN MG53_FAMIGLIE ON
			MG53_DITTA_CG18=MG66_DITTA_CG18 AND
			MG53_CODFAM=MG66_FAM_MG53
			LEFT OUTER JOIN MG54_SOTTOFAM ON 
			MG66_ANAGRART.MG66_DITTA_CG18 = MG54_SOTTOFAM.MG54_DITTA_CG18 AND 
            MG66_ANAGRART.MG66_FAM_MG53 = MG54_SOTTOFAM.MG54_CODFAM_MG53 AND 
            MG66_ANAGRART.MG66_SFAM_MG54 = MG54_SOTTOFAM.MG54_CODSFAM 
			LEFT OUTER JOIN MG55_GRUPPI ON 
			MG66_ANAGRART.MG66_DITTA_CG18 = MG55_GRUPPI.MG55_DITTA_CG18 AND 
            MG66_ANAGRART.MG66_FAM_MG53 = MG55_GRUPPI.MG55_CODFAM_MG53 AND 
            MG66_ANAGRART.MG66_SFAM_MG54 = MG55_GRUPPI.MG55_CODSFAM_MG54 AND 
            MG66_ANAGRART.MG66_GRUPPO_MG55 = MG55_GRUPPI.MG55_CODGRUPPO
			LEFT OUTER JOIN MG56_SOTTOGRUPPI ON 
			MG66_ANAGRART.MG66_DITTA_CG18 = MG56_SOTTOGRUPPI.MG56_DITTA_CG18 AND 
            MG66_ANAGRART.MG66_FAM_MG53 = MG56_SOTTOGRUPPI.MG56_CODFAM_MG53 AND 
            MG66_ANAGRART.MG66_SFAM_MG54 = MG56_SOTTOGRUPPI.MG56_CODSFAM_MG54 AND 
            MG66_ANAGRART.MG66_GRUPPO_MG55 = MG56_SOTTOGRUPPI.MG56_CODGRUPPO_MG55 AND 
            MG66_ANAGRART.MG66_SGRUPPO_MG56 = MG56_SOTTOGRUPPI.MG56_CODSGRUPPO
			LEFT OUTER JOIN DO35_DOCCORPOPERS ON
			DO35_DITTA_CG18=DO30_DITTA_CG18 AND
			DO35_NUMREG_CO99=DO30_NUMREG_CO99 AND
			DO35_PROGRIGA=DO30_PROGRIGA
			WHERE DO30_DITTA_CG18=DO11_DITTA_CG18 AND DO30_NUMREG_CO99=DO11_NUMREG_CO99
			AND DO30_INDTIPORIGA=0 
			ORDER BY DO30_PROGVISUASTA
			) DO30_ARTRIP
OUTER APPLY (
			SELECT TOP 1 *
			FROM DO30_DOCCORPO
			WHERE DO30_DITTA_CG18=DO11_DITTA_CG18 AND DO30_NUMREG_CO99=DO11_NUMREG_CO99
			AND DO30_CODSPESA_MG04 IN ('PO', 'GI', 'FO', 'AL') 
			ORDER BY DO30_PROGVISUASTA
			) DO30_TEMPI
OUTER APPLY (
			SELECT TOP 1 *
			FROM DO30_DOCCORPO
			WHERE DO30_DITTA_CG18=DO11_DITTA_CG18 AND DO30_NUMREG_CO99=DO11_NUMREG_CO99
			AND DO30_CODTESTOFIX_MG62 = 'STA'
			ORDER BY DO30_PROGVISUASTA
			) DO30_PROBLEMA
OUTER APPLY (
			SELECT TOP 1 *
			FROM DO30_DOCCORPO
			WHERE DO30_DITTA_CG18=DO11_DITTA_CG18 AND DO30_NUMREG_CO99=DO11_NUMREG_CO99
			AND DO30_CODTESTOFIX_MG62 = 'OPE'
			ORDER BY DO30_PROGVISUASTA
			) DO30_OPERAZIONE
OUTER APPLY (
			SELECT SUM(DO30_COSTOTOT) AS COSTOTOT, SUM(DO30_COSTOTOT_VAL) AS COSTOTO_VAL
			FROM (SELECT DO30_COSTOTOT, DO30_COSTOTOT_VAL, ROW_NUMBER() OVER (PARTITION BY DO30_DITTA_CG18, DO30_NUMREG_CO99 ORDER BY DO30_PROGVISUASTA) AS NUM_RIGA 
					FROM DO30_DOCCORPO
					WHERE DO30_DITTA_CG18=DO11_DITTA_CG18 AND DO30_NUMREG_CO99=DO11_NUMREG_CO99
					AND DO30_CODSPESA_MG04 IN ('PO', 'GI', 'FO', 'AL') 
					) DO30_COSTI
			WHERE DO30_COSTI.NUM_RIGA > 1) DO30_COSTI1
WHERE DO11_DITTA_CG18 = 1 AND DO11_DOCUM_MG36 = 'C-OR'
--AND DO11_ANNODOC = 2019
--ORDER BY DO11_DATADOC, DO11_NUMDOC
)



--SELECT * FROM VOLPI_RIPARAZIONI