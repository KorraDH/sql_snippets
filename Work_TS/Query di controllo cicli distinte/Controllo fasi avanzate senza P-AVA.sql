SELECT DO11_NUMDOC, DO30_ODL.DO30_CODART_MG66, DO46_ODL.DO46_CODSEQFASE, DO46_ODL.DO46_QTA1CONSOLID
, *
FROM DO11_DOCTESTATA
INNER JOIN DO30_DOCCORPO DO30_ODL ON
DO11_NUMREG_CO99=DO30_ODL.DO30_NUMREG_CO99
INNER JOIN DO46_DOCCORORDDET DO46_ODL ON
DO30_ODL.DO30_NUMREG_CO99=DO46_ODL.DO46_NUMREG_CO99 AND
DO30_ODL.DO30_PROGRIGA=DO46_ODL.DO46_PROGRIGA AND
DO46_ODL.DO46_CODSEQFASE=(SELECT MAX(DO46_CODSEQFASE) FROM DO46_DOCCORORDDET DO46_A 
														WHERE DO46_A.DO46_NUMREG_CO99=DO46_ODL.DO46_NUMREG_CO99 AND
														DO46_A.DO46_PROGRIGA=DO46_ODL.DO46_PROGRIGA
														GROUP BY DO46_A.DO46_NUMREG_CO99, DO46_A.DO46_PROGRIGA
							)
WHERE DO11_DOCUM_MG36 = 'P-ODL-MES'
--AND DO11_NUMDOC = 11783
AND DO46_ODL.DO46_QTA1CONSOLID <> 0 AND DO46_ODL.DO46_INDFASEINTEST = 0
AND DO46_ODL.DO46_QTA1CONSOLID <> ISNULL((SELECT SUM(DO30_AVA.DO30_QTA1)	FROM DO30_DOCCORPO DO30_AVA
																	INNER JOIN DO11_DOCTESTATA DO11_AVA ON
																	DO11_AVA.DO11_NUMREG_CO99=DO30_AVA.DO30_NUMREG_CO99 AND
																	DO11_AVA.DO11_DOCUM_MG36 = 'P-AVA'
																	INNER JOIN DO33_DOCCORPORIF ON
																	DO33_NUMREG_CO99=DO30_AVA.DO30_NUMREG_CO99 AND
																	DO33_PROGRIGA=DO30_AVA.DO30_PROGRIGA
																	WHERE DO33_NUMREGRIF_CO99=DO30_ODL.DO30_NUMREG_CO99 AND
																	DO33_PROGRIGARIF_DO30=DO30_ODL.DO30_PROGRIGA
																	),0)